on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

name: MSRV 1.85 Check

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v1.2.0
      - uses: dtolnay/rust-toolchain@1.85

      - name: Install capnp dependencies
        run: sudo apt-get install -y capnproto libcapnp-dev

      - name: Build stratum-apps workspace
        run: cargo build --manifest-path=stratum-apps/Cargo.toml --all-features

      - name: Build pool
        run: cargo build --manifest-path=pool-apps/Cargo.toml

      - name: Build jd-server (separate workspace)
        run: cargo build --manifest-path=pool-apps/jd-server/Cargo.toml

      - name: Build miner applications workspace
        run: cargo build --manifest-path=miner-apps/Cargo.toml

      - name: Build mining-device (separate workspace)
        run: cargo build --manifest-path=miner-apps/mining-device/Cargo.toml

      - name: Build integration tests workspace
        run: cargo build --manifest-path=integration-tests/Cargo.toml

      - name: Build bitcoin-core-sv2 crate
        run: cargo build --manifest-path=bitcoin-core-sv2/Cargo.toml

      # Also check test compilation without running tests
      - name: Check test compilation for stratum-apps workspace
        run: cargo test --manifest-path=stratum-apps/Cargo.toml --all-features --no-run

      - name: Check test compilation for pool
        run: cargo test --manifest-path=pool-apps/Cargo.toml --no-run

      - name: Check test compilation for jd-server
        run: cargo test --manifest-path=pool-apps/jd-server/Cargo.toml --no-run

      - name: Check test compilation for miner applications workspace
        run: cargo test --manifest-path=miner-apps/Cargo.toml --no-run

      - name: Check test compilation for mining-device
        run: cargo test --manifest-path=miner-apps/mining-device/Cargo.toml --no-run

      - name: Check test compilation for integration tests workspace
        run: cargo test --manifest-path=integration-tests/Cargo.toml --no-run

      - name: Check test compilation for bitcoin-core-sv2 crate
        run: cargo test --manifest-path=bitcoin-core-sv2/Cargo.toml --no-run
